package mine;

import base.BaseModel;
import comm.*;
import gameset.ActiveVo;
import gameset.GameSetModel;
import gluffy.comm.BaseRqst;
import gluffy.utils.JkTools;
import protocol.*;
import table.MineralResBaseVo;
import table.UserDataEnum;

import java.util.ArrayList;

/**
 * Created by admin on 2017/7/4.
 */
public class MR_ExploitCmd extends BaseRqstCmd{
    @Override
    public void execute(Client client, User user, BaseRqst baseRqst) {
        if(!GameSetModel.checkTime(15)){
            new ServerTipRspd(client,(short)359,null);
            return;
        }
        int count = user.getUserData(UserDataEnum.MR_EXPLOIT_COUNT);
        if(count <= 0)return;
        MineModel mineModel = user.cacheUserVo.mineModel;
        if(mineModel.endTime != 0)return;
        MineralResBaseVo mineralResBaseVo = Model.MineralResBaseMap.get((int)mineModel.mineType);
        if(mineralResBaseVo == null)return;
        ArrayList<PropPVo> mineList = BaseModel.getDropProps(mineralResBaseVo.drop[0],0);
        for(PropPVo propPVo : mineList){
            if(propPVo.baseID != UserDataEnum.MR_MINE_COUNT)continue;
            mineModel.total += propPVo.count;
        }
        mineModel.stoneList = BaseModel.getDropProps(mineralResBaseVo.drop[1],0);
        mineModel.startTime = JkTools.getGameServerTime(null);
        mineModel.endTime = mineModel.startTime + mineralResBaseVo.operateTime * 60;
        ActiveVo activeVo = GameSetModel.timeMap.get(15);
        mineModel.mineStartTime = activeVo.startTime;
        mineModel.mineEndTime = activeVo.endTime;
        mineModel.saveSqlData();
        user.setUserData(UserDataEnum.MR_EXPLOIT_COUNT,--count,true);
        ArrayList<TeamUserPVo> users = new ArrayList<>();
        mineModel.sendLootMsg = false;
        new MR_ExploitRspd(client,mineModel.mineType,mineModel.total,mineModel.stoneList,mineModel.lostMineCount,mineModel.lostStoneCount,mineModel.startTime,mineModel.endTime,users);
    }
}
